<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Project Diablo 2 Tiles (act0)</title>

<!--
  Project: Project Diablo 2 Tiles (act0)
  Version: 1.0
  Author: Gimli
  Description: Graphic preview for ingame tile graphics (beta)
-->

<style>
:root {
  --bg: #0b0b0b;
  --panel: #141414;
  --border: #5a3a1a;
  --text: #d6c7a1;
  --accent: #b88a3a;
  --hover: #1f1f1f;
}

html, body {
  margin: 0;
  height: 100%;
  font-family: "Trebuchet MS", serif;
  color: var(--text);
  background:
    url("https://www.transparenttextures.com/patterns/dark-mosaic.png"),
    radial-gradient(circle at top, #1a1208, #050302);
}

#header {
  padding: 16px;
  font-size: 26px;
  letter-spacing: 1px;
  text-shadow: 0 0 6px #000;
  border-bottom: 2px solid var(--border);
  background: linear-gradient(#1a1208, #0b0703);
}

#container {
  display: flex;
  height: calc(100% - 64px);
}

#sidebar {
  width: 280px;
  background: var(--panel);
  border-right: 2px solid var(--border);
  overflow-y: auto;
}

#sidebar h3 {
  margin: 10px;
  font-size: 14px;
  color: var(--accent);
}

.item {
  padding: 8px 12px;
  cursor: pointer;
  border-bottom: 1px solid #1f1f1f;
}

.item:hover {
  background: var(--hover);
}

.folder {
  color: #d9b56a;
}

.file {
  color: #cfcfcf;
}

.back {
  font-weight: bold;
  color: var(--accent);
  border-bottom: 2px solid var(--border);
}

#main {
  flex: 1;
  padding: 16px;
  overflow: auto;
}

.filename {
  margin: 8px 0 6px;
  font-size: 14px;
  color: var(--accent);
}

pre {
  background: #0d0d0d;
  padding: 16px;
  border: 1px solid var(--border);
  white-space: pre-wrap;
  box-shadow: inset 0 0 12px #000;
}

canvas, img {
  display: block;
  margin-bottom: 24px;
  border: 1px solid var(--border);
  image-rendering: pixelated;
}

#footer {
  text-align: center;
  font-size: 12px;
  padding: 8px;
  border-top: 2px solid var(--border);
  background: #0b0703;
  color: #9f8b5a;
}
</style>
</head>

<body>
<div id="header">Project Diablo 2 Tiles (act0)</div>

<div id="container">
  <div id="sidebar">
    <h3>Repository</h3>
    <div id="tree"></div>
  </div>

  <div id="main">
    <p>Select a file to view.</p>
  </div>
</div>

<div id="footer">
  graphic preview for ingame tile graphics - beta | v1.0 | made by Gimli
</div>

<script>
const VERSION = "1.0";
const AUTHOR = "Gimli";

const owner = "D2R-Gimli";
const repo = "Diablo2_act0_color_palette";
const apiBase = `https://api.github.com/repos/${owner}/${repo}/contents`;

const tree = document.getElementById("tree");
const main = document.getElementById("main");

let currentPath = "";

const allowedExtensions = [".ini", ".pcx", ".png"];

async function loadDir(path = "") {
  currentPath = path;
  tree.innerHTML = "";

  // Back button
  const back = document.createElement("div");
  back.textContent = ".. back";
  back.className = "item back";
  back.onclick = () => {
    if (!currentPath) return;
    const parts = currentPath.split("/");
    parts.pop();
    loadDir(parts.join("/"));
  };
  tree.appendChild(back);

  const res = await fetch(`${apiBase}/${path}`);
  const items = await res.json();

  items.forEach(item => {
    if (
      item.type === "file" &&
      !allowedExtensions.some(ext => item.name.toLowerCase().endsWith(ext))
    ) return;

    const div = document.createElement("div");
    div.className = "item " + item.type;
    div.textContent = item.name;

    div.onclick = () => {
      if (item.type === "dir") loadDir(item.path);
      else loadFile(item);
    };

    tree.appendChild(div);
  });
}

async function loadFile(item) {
  main.innerHTML = "";

  const title = document.createElement("div");
  title.className = "filename";
  title.textContent = item.name;
  main.appendChild(title);

  if (item.name.endsWith(".ini")) {
    const text = await fetch(item.download_url).then(r => r.text());
    const pre = document.createElement("pre");
    pre.textContent = text;
    main.appendChild(pre);
  }

  else if (item.name.endsWith(".pcx")) {
    const buffer = await fetch(item.download_url).then(r => r.arrayBuffer());
    const canvas = decodePCX(buffer);
    main.appendChild(canvas);
  }

  else if (item.name.endsWith(".png")) {
    const img = document.createElement("img");
    img.src = item.download_url;
    main.appendChild(img);
  }
}

/* Minimal PCX decoder (8-bit indexed) */
function decodePCX(buffer) {
  const data = new Uint8Array(buffer);
  const view = new DataView(buffer);

  const xmin = view.getUint16(4, true);
  const ymin = view.getUint16(6, true);
  const xmax = view.getUint16(8, true);
  const ymax = view.getUint16(10, true);

  const width = xmax - xmin + 1;
  const height = ymax - ymin + 1;

  const imageData = new Uint8Array(width * height);
  let ptr = 128;
  let i = 0;

  while (i < imageData.length && ptr < data.length) {
    let val = data[ptr++];
    if ((val & 0xC0) === 0xC0) {
      let count = val & 0x3F;
      let color = data[ptr++];
      while (count--) imageData[i++] = color;
    } else {
      imageData[i++] = val;
    }
  }

  const paletteStart = data.length - 768;
  const palette = data.slice(paletteStart);

  const canvas = document.createElement("canvas");
  canvas.width = width;
  canvas.height = height;
  const ctx = canvas.getContext("2d");
  const img = ctx.createImageData(width, height);

  for (let p = 0; p < imageData.length; p++) {
    const c = imageData[p] * 3;
    img.data[p * 4] = palette[c];
    img.data[p * 4 + 1] = palette[c + 1];
    img.data[p * 4 + 2] = palette[c + 2];
    img.data[p * 4 + 3] = 255;
  }

  ctx.putImageData(img, 0, 0);
  return canvas;
}

loadDir();
</script>
</body>
</html>
