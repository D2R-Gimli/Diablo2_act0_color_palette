<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Project Diablo 2 Tiles (act0)</title>

<!--
  Project: Project Diablo 2 Tiles (act0)
  Version: 1.0
  Author: Gimli
  Description: Graphic preview for ingame tile graphics (beta)
-->

<style>
:root {
  --stone-dark: #1a1a1a;
  --stone-mid: #2a2a2a;
  --stone-light: #3a3a3a;
  --border: #5a3a1a;
  --text: #d6c7a1;
  --accent: #c9a24d;
}

html, body {
  margin: 0;
  height: 100%;
  background:
    url("https://www.transparenttextures.com/patterns/stone-wall.png"),
    radial-gradient(circle at top, #1a1208, #050302);
  color: var(--text);
  font-family: "Trebuchet MS", serif;
}

#header {
  display: flex;
  align-items: center;
  padding: 10px 16px;
  background:
    linear-gradient(#2a2a2a, #141414);
  border-bottom: 3px solid var(--border);
  box-shadow:
    inset 0 -2px 4px #000,
    0 2px 6px #000;
}

#header img {
  height: 48px;
}

#container {
  display: flex;
  height: calc(100% - 92px);
}

#sidebar {
  width: 220px;
  background:
    linear-gradient(#262626, #161616);
  border-right: 3px solid var(--border);
  box-shadow:
    inset -2px 0 6px #000;
  overflow-y: auto;
}

#sidebar h3 {
  margin: 10px;
  font-size: 13px;
  color: var(--accent);
}

.item {
  padding: 8px 12px;
  cursor: pointer;
  border-bottom: 1px solid #1f1f1f;
}

.item:hover {
  background: #222;
}

.folder { color: #d9b56a; }
.file { color: #cfcfcf; }

.back {
  font-weight: bold;
  color: var(--accent);
  background: #1c1c1c;
}

#main {
  flex: 1;
  padding: 16px;
  overflow-y: auto;
  background:
    linear-gradient(#1a1a1a, #0f0f0f);
  box-shadow:
    inset 0 0 12px #000;
}

.filename {
  margin: 10px 0 6px;
  font-size: 14px;
  color: var(--accent);
}

pre {
  background: #0d0d0d;
  padding: 16px;
  border: 2px solid var(--border);
  box-shadow: inset 0 0 12px #000;
  white-space: pre-wrap;
  font-family: Consolas, monospace;
  font-size: 13px;
}

/* INI highlighting */
.ini-section { color: #c9a24d; }
.ini-key { color: #e0d6b8; }
.ini-eq { color: #777; }
.ini-value { color: #8fb98f; }
.ini-comment { color: #666; }

canvas, img {
  display: block;
  margin-bottom: 24px;
  border: 2px solid var(--border);
  image-rendering: pixelated;
  background: #000;
}

#footer {
  position: fixed;
  bottom: 0;
  width: 100%;
  text-align: center;
  font-size: 12px;
  padding: 8px;
  background: #0b0703;
  border-top: 3px solid var(--border);
  color: #9f8b5a;
}
</style>
</head>

<body>

<div id="header">
  <img src="https://raw.githubusercontent.com/D2R-Gimli/Diablo2_act0_color_palette/main/title.png" alt="Project Diablo 2 Tiles">
</div>

<div id="container">
  <div id="sidebar">
    <h3>Tiles</h3>
    <div id="tree"></div>
  </div>

  <div id="main">
    <p>Select a file to view.</p>
  </div>
</div>

<div id="footer">
  graphic preview for ingame tile graphics - beta | v1.0 | made by Gimli
</div>

<script>
const owner = "D2R-Gimli";
const repo = "Diablo2_act0_color_palette";
const apiBase = `https://api.github.com/repos/${owner}/${repo}/contents`;

const ROOT_PATH = "data/global/tiles";

const tree = document.getElementById("tree");
const main = document.getElementById("main");

let currentPath = ROOT_PATH;
const allowedExtensions = [".ini", ".pcx", ".png"];

async function loadDir(path) {
  currentPath = path;
  tree.innerHTML = "";

  // Back button (locked to ROOT_PATH)
  if (currentPath !== ROOT_PATH) {
    const back = document.createElement("div");
    back.textContent = ".. back";
    back.className = "item back";
    back.onclick = () => {
      const parts = currentPath.split("/");
      parts.pop();
      const newPath = parts.join("/");
      loadDir(newPath.startsWith(ROOT_PATH) ? newPath : ROOT_PATH);
    };
    tree.appendChild(back);
  }

  const res = await fetch(`${apiBase}/${path}`);
  const items = await res.json();

  items.forEach(item => {
    if (
      item.type === "file" &&
      !allowedExtensions.some(ext => item.name.toLowerCase().endsWith(ext))
    ) return;

    const div = document.createElement("div");
    div.className = "item " + item.type;
    div.textContent = item.name;

    div.onclick = () => {
      if (item.type === "dir") loadDir(item.path);
      else loadFile(item);
    };

    tree.appendChild(div);
  });
}

function highlightINI(text) {
  return text.split("\n").map(line => {
    if (/^\s*[;#]/.test(line))
      return `<span class="ini-comment">${line}</span>`;
    if (/^\s*\[.*\]/.test(line))
      return `<span class="ini-section">${line}</span>`;
    if (line.includes("=")) {
      const [k, v] = line.split("=");
      return `<span class="ini-key">${k}</span><span class="ini-eq">=</span><span class="ini-value">${v}</span>`;
    }
    return line;
  }).join("\n");
}

async function loadFile(item) {
  main.innerHTML = "";

  const title = document.createElement("div");
  title.className = "filename";
  title.textContent = item.name;
  main.appendChild(title);

  if (item.name.endsWith(".ini")) {
    const text = await fetch(item.download_url).then(r => r.text());
    const pre = document.createElement("pre");
    pre.innerHTML = highlightINI(text);
    main.appendChild(pre);
  }

  else if (item.name.endsWith(".pcx")) {
    const buffer = await fetch(item.download_url).then(r => r.arrayBuffer());
    main.appendChild(decodePCX(buffer));
  }

  else if (item.name.endsWith(".png")) {
    const img = document.createElement("img");
    img.src = item.download_url;
    main.appendChild(img);
  }
}

/* PCX decoder (8-bit indexed) */
function decodePCX(buffer) {
  const data = new Uint8Array(buffer);
  const view = new DataView(buffer);

  const w = view.getUint16(8, true) - view.getUint16(4, true) + 1;
  const h = view.getUint16(10, true) - view.getUint16(6, true) + 1;

  const pixels = new Uint8Array(w * h);
  let p = 128, i = 0;

  while (i < pixels.length) {
    let v = data[p++];
    if ((v & 0xC0) === 0xC0) {
      let c = v & 0x3F;
      let col = data[p++];
      while (c--) pixels[i++] = col;
    } else pixels[i++] = v;
  }

  const pal = data.slice(data.length - 768);
  const canvas = document.createElement("canvas");
  canvas.width = w;
  canvas.height = h;

  const ctx = canvas.getContext("2d");
  const img = ctx.createImageData(w, h);

  for (let j = 0; j < pixels.length; j++) {
    const c = pixels[j] * 3;
    img.data[j * 4] = pal[c];
    img.data[j * 4 + 1] = pal[c + 1];
    img.data[j * 4 + 2] = pal[c + 2];
    img.data[j * 4 + 3] = 255;
  }

  ctx.putImageData(img, 0, 0);
  return canvas;
}

loadDir(ROOT_PATH);
</script>
</body>
</html>
